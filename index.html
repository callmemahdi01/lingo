<!DOCTYPE html>
<html lang="fa" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پلتفرم یادگیری زبان با ویدیو</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
    :root {
        --bg-color: #121212;
        --surface-color: #1e1e1e;
        --primary-color: #bb86fc;
        --secondary-color: #03dac6;
        --text-color: #e0e0e0;
        --text-secondary-color: #a0a0a0;
        --active-bg: rgba(187, 134, 252, 0.15);
        --border-color: rgba(255, 255, 255, 0.1);
        --shadow-color: rgba(0, 0, 0, 0.5);
        --hover-bg: rgba(255, 255, 255, 0.05);
        --active-shadow: rgba(187, 134, 252, 0.3);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html, body {
        height: 100vh;
        font-family: 'Vazirmatn', sans-serif;
        background: #000;
        color: var(--text-color);
        overflow: hidden;
    }

    body {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5px;
    }

    ::-webkit-scrollbar { 
        width: 8px; 
    }
    ::-webkit-scrollbar-track { 
        background: var(--surface-color); 
        border-radius: 10px; 
    }
    ::-webkit-scrollbar-thumb { 
        background: var(--primary-color); 
        border-radius: 10px; 
    }
    
    .player-wrapper {
        position: relative;
        width: 100%;
        max-width: 900px;
        height: 100%;
        background-color: var(--surface-color);
        box-shadow: 0 15px 35px var(--shadow-color);
        border-radius: 20px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease-out;
    }

    .video-container {
        position: relative;
        background: var(--surface-color);
        box-shadow: #1e1e1e 0px 10px 15px 8px;
        z-index: 100;
        border-radius: 15px;
        overflow: hidden;
    }

    video {
        width: 100%;
        height: auto;
        display: block;
        object-fit: contain;
        border-radius: 10px;
    }

    video::-webkit-media-controls-closed-captions-button,
    video::-webkit-media-controls-volume-slider,
    video::-webkit-media-controls-mute-button { 
        display: none !important; 
    }

    .subtitles-container {
        flex: 1;
        overflow-y: auto;
        padding: 15px 20px;
        background-color: var(--surface-color);
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .subtitles-container.hide-persian .subtitle-fa {
        display: none;
    }

    .subtitles-container::-webkit-scrollbar {
        display: none;
    }

    .subtitle-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        transition: all 0.2s ease;
        border-radius: 10px;
        max-width: 100ch;
        margin: 0 auto 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: relative;
    }

    .subtitle-item:last-child { 
        border-bottom: none; 
    }

    .subtitle-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 0;
        background: var(--primary-color);
        border-radius: 2px;
        transition: height 0.2s ease;
    }

    .subtitle-item.active::before {
        height: 60%;
    }

    .subtitle-en {
        font-size: 18px;
        line-height: 1.6;
        color: var(--text-color);
        direction: ltr;
        text-align: left;
        transition: color 0.1s ease;
        font-weight: 900;
    }

    .subtitle-fa {
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-secondary-color);
        direction: rtl;
        text-align: right;
        transition: color 0.2s ease, display 0.3s;
    }

    .subtitle-item:hover { 
        background-color: var(--hover-bg);
        transform: translateX(-5px);
    }

    .subtitle-item.active {
        background-color: var(--active-bg);
        transform: translateX(-8px);
        box-shadow: 0 4px 12px var(--active-shadow);
    }

    .subtitle-item.active .subtitle-en { 
        font-weight: 600; 
        color: var(--primary-color); 
    }

    .subtitle-item.active .subtitle-fa { 
        color: var(--secondary-color); 
        font-weight: 500;
    }

    .feedback-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        padding: 10px 15px;
        border-radius: 30px;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .feedback-indicator.visible {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .feedback-text {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
        text-align: center;
    }

    .progress-bar {
        width: 120px;
        height: 8px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        transition: width 0.3s ease;
        border-radius: 4px;
    }

    .fullscreen-btn, .toggle-fa-btn {
    position: fixed;
    left: 5px;
    padding: 5px 10px;
    z-index: 9999;
    font-size: 24px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.05); /* شفاف */
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.15);
    cursor: pointer;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px); /* افکت شیشه‌ای اصلی */
    -webkit-backdrop-filter: blur(10px); /* برای سافاری */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

.fullscreen-btn {
    top: 5px;
}

.toggle-fa-btn {
    top: 55px;
    font-size: 10px;
    font-weight: bold;
    padding: 12px 5px;
    left: 2px;
}

.fullscreen-btn:hover, .toggle-fa-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.05);
}

.toggle-fa-btn.disabled {
    opacity: 0.4;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(5px);
}


    /* Responsive Design */
    @media (max-width: 768px) {
        body { padding: 5px; }
        .player-wrapper { border-radius: 0; }
        .video-container { border-radius: 0; }
        .subtitles-container { padding: 10px 15px; }
        video { border-radius: 0; }
        .subtitle-item { padding: 10px 12px; margin-bottom: 6px; }
        .subtitle-en { font-size: 17px; }
        .subtitle-fa { font-size: 13px; }
        .feedback-indicator { padding: 12px 20px; gap: 12px; }
        .progress-bar { width: 100px; height: 6px; }
    }

    @media (max-width: 480px) {
        .subtitle-en { font-size: 16px; }
        .subtitle-fa { font-size: 12px; }
    }

    /* Loading state */
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100px;
        font-size: 18px;
        color: var(--text-secondary-color);
    }
</style>
</head>
<body>
    <div class="player-wrapper">
        <div class="video-container">
            <video id="videoPlayer" controls preload="metadata" controlsList="nodownload novolume">
                <source src="./vid/after/after.mp4" type="video/mp4">
                <track id="track-en" src="./vid/after/after-en.vtt" kind="subtitles" srclang="en" label="English">
                <track id="track-fa" src="./vid/after/after-fa.vtt" kind="subtitles" srclang="fa" label="فارسی">
                مرورگر شما از تگ ویدیو پشتیبانی نمی‌کند.
            </video>
            
            <div id="feedback-indicator" class="feedback-indicator">
                <span id="feedback-text" class="feedback-text"></span>
                <div id="progress-bar-container" class="progress-bar" style="display: none;">
                    <div id="progress-bar-fill" class="progress-bar-fill"></div>
                </div>
            </div>
        </div>
        
        <div id="subtitles-container" class="subtitles-container">
            <div class="loading">در حال بارگذاری زیرنویس‌ها...</div>
        </div>
    </div>

    <script>
        class VideoPlayer {
            constructor() {
                this.elements = {
                    video: document.getElementById('videoPlayer'),
                    subtitlesContainer: document.getElementById('subtitles-container'),
                    trackEn: document.getElementById('track-en'),
                    trackFa: document.getElementById('track-fa'),
                    feedbackIndicator: document.getElementById('feedback-indicator'),
                    feedbackText: document.getElementById('feedback-text'),
                    progressBarContainer: document.getElementById('progress-bar-container'),
                    progressBarFill: document.getElementById('progress-bar-fill'),
                    fullscreenBtn: null, // Will be created dynamically
                    toggleFaBtn: null,   // Will be created dynamically
                };

                this.state = {
                    enCues: [],
                    faCues: [],
                    currentCueIndex: -1,
                    feedbackTimeout: null,
                    syncRafId: null,
                    isFullscreen: false,
                    persianSubtitlesVisible: true, // New state for Persian subtitles
                    videoKey: null,
                    saveTimeout: null,
                    persianSubsVisibleKey: null, // New key for localStorage
                };

                this.config = {
                    maxTimeDiff: 1.5,
                    lookAheadLimit: 5,
                    volumeStep: 0.05,
                    feedbackDuration: 500,
                    saveInterval: 2000
                };

                if (this.elements.video.readyState > 0) {
                    this.init();
                } else {
                    this.elements.video.addEventListener('loadedmetadata', () => this.init(), { once: true });
                }
            }
            
            async init() {
                try {
                    this.state.videoKey = `video_progress_${this.elements.video.currentSrc}`;
                    this.state.persianSubsVisibleKey = `persian_subs_visible_${this.elements.video.currentSrc}`;
                    
                    this.setupFullscreenButton();
                    this.setupSubtitleToggleButton(); // New method call
                    this.loadPersianVisibility(); // Load preference
                    
                    await this.loadSubtitles();
                    this.renderSubtitles();
                    this.setupEventListeners();
                    this.loadLastTime();
                    this.startSync();
                } catch (error) {
                    console.error('خطا در بارگذاری پلیر:', error);
                    this.showError('خطا در بارگذاری زیرنویس‌ها');
                }
            }
            
            async loadSubtitles() {
                const [enCues, faCues] = await Promise.all([
                    this.loadTrack(this.elements.trackEn),
                    this.loadTrack(this.elements.trackFa)
                ]);
                
                this.state.enCues = enCues;
                this.state.faCues = faCues;
            }
            
            loadTrack(trackElement) {
                return new Promise((resolve, reject) => {
                    const track = trackElement.track;
                    track.mode = 'hidden';
                    
                    const handleLoad = () => resolve(Array.from(track.cues || []));
                    const handleError = () => reject(new Error(`خطا در بارگذاری ${track.language}`));
                    
                    if (track.readyState === 2) {
                        handleLoad();
                    } else {
                        trackElement.addEventListener('load', handleLoad, { once: true });
                        trackElement.addEventListener('error', handleError, { once: true });
                    }
                });
            }
            
            renderSubtitles() {
                const fragment = document.createDocumentFragment();
                const { enCues, faCues } = this.state;
                const { maxTimeDiff, lookAheadLimit } = this.config;
                
                let faSearchIndex = 0;
                
                enCues.forEach((enCue, i) => {
                    const bestMatch = this.findBestMatch(enCue, faCues, faSearchIndex, lookAheadLimit, maxTimeDiff);
                    
                    let faText = '';
                    if (bestMatch.index !== -1) {
                        faText = faCues[bestMatch.index].text;
                        faSearchIndex = bestMatch.index + 1;
                    }

                    const subtitleItem = this.createSubtitleItem(enCue.text, faText, i, enCue.startTime);
                    fragment.appendChild(subtitleItem);
                });
                
                this.elements.subtitlesContainer.innerHTML = '';
                this.elements.subtitlesContainer.appendChild(fragment);
            }
            
            findBestMatch(enCue, faCues, startIndex, lookAheadLimit, maxTimeDiff) {
                let bestMatch = { index: -1, diff: Infinity };
                const endIndex = Math.min(faCues.length, startIndex + lookAheadLimit);
                
                for (let j = startIndex; j < endIndex; j++) {
                    const diff = Math.abs(enCue.startTime - faCues[j].startTime);
                    
                    if (diff < bestMatch.diff && diff < maxTimeDiff) {
                        bestMatch = { index: j, diff };
                    }
                }
                
                return bestMatch;
            }
            
            createSubtitleItem(enText, faText, index, startTime) {
                const item = document.createElement('div');
                item.className = 'subtitle-item';
                item.dataset.index = index;
                
                const enDiv = this.createElement('div', 'subtitle-en', enText);
                const faDiv = this.createElement('div', 'subtitle-fa', faText);
                
                item.append(enDiv, faDiv);
                item.addEventListener('click', () => this.seekToTime(startTime));
                
                return item;
            }
            
            createElement(tag, className, textContent) {
                const element = document.createElement(tag);
                element.className = className;
                element.textContent = textContent;
                return element;
            }
            
            seekToTime(time) {
                this.elements.video.currentTime = time;
                if (this.elements.video.paused) {
                    this.elements.video.play();
                }
            }
            
            startSync() {
                const sync = () => {
                    this.updateActiveSubtitle();
                    this.state.syncRafId = requestAnimationFrame(sync);
                };
                sync();
            }
            
            updateActiveSubtitle() {
                const currentTime = this.elements.video.currentTime;
                const activeIndex = this.state.enCues.findIndex(cue => 
                    currentTime >= cue.startTime && currentTime < cue.endTime
                );
                
                if (activeIndex !== this.state.currentCueIndex) {
                    this.setActiveSubtitle(activeIndex);
                    this.state.currentCueIndex = activeIndex;
                }
            }
            
            setActiveSubtitle(index) {
                const items = this.elements.subtitlesContainer.children;
                
                if (this.state.currentCueIndex >= 0 && items[this.state.currentCueIndex]) {
                    items[this.state.currentCueIndex].classList.remove('active');
                }
                
                if (index >= 0 && items[index]) {
                    const activeItem = items[index];
                    activeItem.classList.add('active');
                    this.scrollToSubtitle(activeItem);
                }
            }
            
            scrollToSubtitle(element) {
                element.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'nearest'
                });
            }
            
            showFeedback(text, progressValue = -1) {
                clearTimeout(this.state.feedbackTimeout);
                
                this.elements.feedbackText.textContent = text;
                
                if (progressValue >= 0) {
                    this.elements.progressBarContainer.style.display = 'block';
                    this.elements.progressBarFill.style.width = `${Math.min(100, Math.max(0, progressValue))}%`;
                } else {
                    this.elements.progressBarContainer.style.display = 'none';
                }
                
                this.elements.feedbackIndicator.classList.add('visible');
                
                this.state.feedbackTimeout = setTimeout(() => {
                    this.elements.feedbackIndicator.classList.remove('visible');
                }, this.config.feedbackDuration);
            }
            
            showError(message) {
                this.elements.subtitlesContainer.innerHTML = `
                    <div class="loading" style="color: #ff6b6b;">
                        ${message}
                    </div>
                `;
            }

            saveLastTime() {
                if (!this.state.videoKey) return;
                const currentTime = this.elements.video.currentTime;
                if (currentTime > 0 && !this.elements.video.ended) {
                    localStorage.setItem(this.state.videoKey, currentTime.toString());
                }
            }

            loadLastTime() {
                if (!this.state.videoKey) return;
                const savedTime = localStorage.getItem(this.state.videoKey);
                if (savedTime) {
                    this.elements.video.currentTime = parseFloat(savedTime);
                }
            }

            setupEventListeners() {
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
                
                this.elements.video.addEventListener('play', () => this.showFeedback('▶'));
                this.elements.video.addEventListener('pause', () => this.showFeedback('❚❚'));

                this.elements.video.addEventListener('timeupdate', () => {
                    if (!this.state.saveTimeout) {
                        this.state.saveTimeout = setTimeout(() => {
                            this.saveLastTime();
                            this.state.saveTimeout = null;
                        }, this.config.saveInterval);
                    }
                });

                this.elements.video.addEventListener('ended', () => {
                    if(this.state.videoKey) {
                        localStorage.removeItem(this.state.videoKey);
                    }
                });
                
                document.addEventListener('fullscreenchange', () => this.handleFullscreenChange());
                
                window.addEventListener('beforeunload', () => this.cleanup());
            }
            
            handleKeyboard(event) {
                if (['INPUT', 'TEXTAREA'].includes(event.target.tagName)) return;
                
                const keyActions = {
                    'Space': () => this.togglePlayPause(),
                    'ArrowRight': () => this.jumpToNext(),
                    'ArrowLeft': () => this.jumpToPrevious(),
                    'ArrowUp': () => this.adjustVolume(this.config.volumeStep),
                    'ArrowDown': () => this.adjustVolume(-this.config.volumeStep),
                    'Enter': () => this.toggleFullScreen()
                };
                
                const action = keyActions[event.code];
                if (action) {
                    event.preventDefault();
                    action();
                }
            }
            
            togglePlayPause() {
                if (this.elements.video.paused) {
                    this.elements.video.play();
                } else {
                    this.elements.video.pause();
                }
            }
            
            jumpToNext() {
                const currentTime = this.elements.video.currentTime;
                const nextCue = this.state.enCues.find(cue => cue.startTime > currentTime);
                
                if (nextCue) {
                    this.seekToTime(nextCue.startTime);
                    this.showFeedback('⏭');
                }
            }
            
            jumpToPrevious() {
                const currentTime = this.elements.video.currentTime;
                const prevCue = [...this.state.enCues]
                    .reverse()
                    .find(cue => cue.startTime < currentTime - 0.5);
                
                if (prevCue) {
                    this.seekToTime(prevCue.startTime);
                    this.showFeedback('⏮');
                }
            }
            
            adjustVolume(delta) {
                const newVolume = Math.max(0, Math.min(1, this.elements.video.volume + delta));
                this.elements.video.volume = newVolume;
                
                const volumePercent = Math.round(newVolume * 100);
                const volumeIcon = newVolume === 0 ? '🔇' : newVolume < 0.5 ? '🔉' : '🔊';
                this.showFeedback(volumeIcon, volumePercent);
            }
            
            setupFullscreenButton() {
                const btn = document.createElement('button');
                btn.textContent = '⛶';
                btn.className = 'fullscreen-btn';
                btn.title = 'تمام صفحه (Enter)';
                btn.addEventListener('click', () => this.toggleFullScreen());
                document.body.appendChild(btn);
                
                this.elements.fullscreenBtn = btn;
            }

            // New method to create subtitle toggle button
            setupSubtitleToggleButton() {
                const btn = document.createElement('button');
                btn.textContent = '❤️فارسی';
                btn.className = 'toggle-fa-btn';
                btn.title = 'نمایش/مخفی کردن زیرنویس فارسی';
                btn.addEventListener('click', () => this.togglePersianVisibility());
                document.body.appendChild(btn);

                this.elements.toggleFaBtn = btn;
            }
            
            // New method to handle Persian subtitle visibility
            togglePersianVisibility() {
                this.state.persianSubtitlesVisible = !this.state.persianSubtitlesVisible;
                this.updatePersianVisibility();
                localStorage.setItem(this.state.persianSubsVisibleKey, this.state.persianSubtitlesVisible);
            }

            // New method to load the saved preference
            loadPersianVisibility() {
                const savedState = localStorage.getItem(this.state.persianSubsVisibleKey);
                // Default to true if nothing is saved
                this.state.persianSubtitlesVisible = savedState !== 'false';
                this.updatePersianVisibility();
            }

            // New method to apply visibility changes
            updatePersianVisibility() {
                this.elements.subtitlesContainer.classList.toggle('hide-persian', !this.state.persianSubtitlesVisible);
                this.elements.toggleFaBtn.classList.toggle('disabled', !this.state.persianSubtitlesVisible);
            }
            
            toggleFullScreen() {
                if (!this.state.isFullscreen) {
                    this.enterFullScreen();
                } else {
                    this.exitFullScreen();
                }
            }
            
            enterFullScreen() {
                const body = document.documentElement;
                const requestMethod = body.requestFullscreen || body.webkitRequestFullscreen || body.msRequestFullscreen;
                if (requestMethod) requestMethod.call(body);
            }
            
            exitFullScreen() {
                const exitMethod = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;
                if (exitMethod) exitMethod.call(document);
            }
            
            handleFullscreenChange() {
                this.state.isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
                
                const shouldShowButtons = !this.state.isFullscreen;
                if (this.elements.fullscreenBtn) {
                    this.elements.fullscreenBtn.style.display = shouldShowButtons ? 'block' : 'none';
                }
                if (this.elements.toggleFaBtn) {
                    this.elements.toggleFaBtn.style.display = shouldShowButtons ? 'block' : 'none';
                }
            }
            
            cleanup() {
                if (this.state.syncRafId) {
                    cancelAnimationFrame(this.state.syncRafId);
                }
                clearTimeout(this.state.feedbackTimeout);
                clearTimeout(this.state.saveTimeout);
                this.saveLastTime();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new VideoPlayer();
        });
    </script>
</body>
</html>